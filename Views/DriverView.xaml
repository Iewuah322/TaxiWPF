<Window x:Class="TaxiWPF.Views.DriverView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:TaxiWPF.ViewModels"
        xmlns:converters="clr-namespace:TaxiWPF.Converters"
        xmlns:gmaps="clr-namespace:GMap.NET.WindowsPresentation;assembly=GMap.NET.WindowsPresentation"
        Title="Экран водителя" Height="720" Width="1280"
        WindowStartupLocation="CenterScreen" MinWidth="1280" MinHeight="720"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        FontFamily="Segoe UI" MouseLeftButtonDown="Window_MouseLeftButtonDown">

    <Border Background="#F0EEE9" CornerRadius="10" BorderBrush="#8D837C" BorderThickness="1">
        <Grid>
            <!-- Кнопка профиля слева -->
            <Button Command="{Binding ToggleProfilePanelCommand}" 
                    Style="{StaticResource AvatarButton}" 
                    HorizontalAlignment="Left" 
                    VerticalAlignment="Top" 
                    Margin="20,15,0,0" 
                    Panel.ZIndex="100">
                <Grid Width="30" Height="30">
                    <TextBlock Text="👤" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    <Ellipse>
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="{Binding CurrentDriver.DriverPhotoUrl, Converter={StaticResource PathToImageConverter}}"/>
                        </Ellipse.Fill>
                    </Ellipse>
                </Grid>
            </Button>
            
            <!-- Кнопка закрытия -->
            <Button Content="✕" Click="CloseButton_Click" Style="{StaticResource CloseButton}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,5,0" Panel.ZIndex="100"/>

            <!-- Статус онлайн/офлайн вверху по центру -->
            <Border Background="#FFFFFF" 
                    Opacity="0.95"
                    CornerRadius="25" 
                    Padding="20,10"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Top"
                    Margin="0,10,0,0"
                    BorderBrush="#E0E0E0"
                    BorderThickness="1"
                    Panel.ZIndex="50">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.2" Color="Black"/>
                </Border.Effect>
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="12" Height="12" Margin="0,0,10,0" VerticalAlignment="Center">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="#DC3545"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                        <Setter Property="Fill" Value="#28A745"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="Офлайн"/>
                                <Setter Property="Foreground" Value="#DC3545"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                        <Setter Property="Text" Value="Онлайн — принимаю заказы"/>
                                        <Setter Property="Foreground" Value="#28A745"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsOnOrder}" Value="True">
                                        <Setter Property="Text" Value="На заказе"/>
                                        <Setter Property="Foreground" Value="#FFC107"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Карта по центру с отступами -->
            <Grid Margin="100,50,100,80">
                <Border CornerRadius="15" Background="Transparent" ClipToBounds="True">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.2" Color="Black"/>
                    </Border.Effect>
                    <gmaps:GMapControl x:Name="MainMap" Zoom="12" MaxZoom="18" MinZoom="5" 
                                       MouseWheelZoomType="MousePositionWithoutCenter" 
                                       CanDragMap="True" />
                </Border>
            </Grid>

            <!-- Кнопка "Начать принимать заказы" внизу по центру (когда офлайн) -->
            <Button Content="🚗 НАЧАТЬ ПРИНИМАТЬ ЗАКАЗЫ" 
                    Command="{Binding StartAcceptingOrdersCommand}"
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,25"
                    Padding="40,18"
                    FontSize="18">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource AcceptButton}">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsOnline}" Value="False">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>

            <!-- Левая панель с заказами (только когда онлайн и не на заказе) -->
            <Border x:Name="OrdersPanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Width="420"
                    Margin="15,50,0,15"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsOnline}" Value="True"/>
                                    <Condition Binding="{Binding IsOnOrder}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Border.Effect>
                    <DropShadowEffect BlurRadius="25" ShadowDepth="5" Opacity="0.3" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок панели -->
                    <Border Grid.Row="0" Background="#F8F8F8" CornerRadius="20,20,0,0" Padding="20,15">
                        <Grid>
                            <TextBlock Text="📋 Доступные заказы" 
                                       FontSize="18" 
                                       FontWeight="Bold" 
                                       Foreground="#333333"
                                       VerticalAlignment="Center"/>
                            <Button Content="⏸ Стоп" 
                                    Command="{Binding StopAcceptingOrdersCommand}" 
                                    HorizontalAlignment="Right"
                                    Padding="15,8"
                                    FontSize="13"
                                    Background="#FFE5E5"
                                    Foreground="#DC3545"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="10"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#DC3545"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Счётчик заказов -->
                    <Border Grid.Row="1" Padding="20,10">
                        <TextBlock FontSize="13" Foreground="#888888">
                            <Run Text="Найдено заказов: "/>
                            <Run Text="{Binding AvailableOrders.Count, Mode=OneWay, FallbackValue=0}" FontWeight="SemiBold" Foreground="#333333"/>
                        </TextBlock>
                    </Border>

                    <!-- Список заказов -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Padding="15,0,15,15">
                        <ListBox ItemsSource="{Binding AvailableOrders}"
                                 SelectedItem="{Binding SelectedOrder, Mode=TwoWay}"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 SelectionMode="Single">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter/>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="Margin" Value="0,0,0,12"/>
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="15" 
                                            Padding="18" 
                                            BorderThickness="2"
                                            Cursor="Hand">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#FAFAFA"/>
                                                <Setter Property="BorderBrush" Value="#E8E8E8"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                                                        <Setter Property="Background" Value="#FFFDF5"/>
                                                        <Setter Property="BorderBrush" Value="#FFC107"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#F5F5F5"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- Откуда -->
                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                                                <Border Background="#E8F5E9" CornerRadius="5" Padding="6,3" Margin="0,0,8,0">
                                                    <TextBlock Text="А" FontWeight="Bold" Foreground="#28A745" FontSize="11"/>
                                                </Border>
                                                <TextBlock Text="{Binding PointA}" 
                                                           FontSize="14" 
                                                           FontWeight="SemiBold" 
                                                           Foreground="#333333" 
                                                           TextWrapping="Wrap"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>

                                            <!-- Куда -->
                                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12">
                                                <Border Background="#FFEBEE" CornerRadius="5" Padding="6,3" Margin="0,0,8,0">
                                                    <TextBlock Text="Б" FontWeight="Bold" Foreground="#DC3545" FontSize="11"/>
                                                </Border>
                                                <TextBlock Text="{Binding PointB}" 
                                                           FontSize="13" 
                                                           Foreground="#666666" 
                                                           TextWrapping="Wrap"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>

                                            <!-- Клиент и рейтинг -->
                                            <Border Grid.Row="2" Background="#F5F5F5" CornerRadius="8" Padding="10,8" Margin="0,0,0,12">
                                                <Grid>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="👤" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                        <TextBlock Text="{Binding OrderClient.full_name}" 
                                                                   FontSize="14" 
                                                                   FontWeight="SemiBold" 
                                                                   Foreground="#333333"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                                        <TextBlock Text="⭐" Foreground="#FFC107" FontSize="14" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding OrderClient.rating, StringFormat=F1, FallbackValue='N/A'}" 
                                                                   FontSize="14" 
                                                                   FontWeight="SemiBold" 
                                                                   Foreground="#333333" 
                                                                   Margin="4,0,0,0"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>

                                            <!-- Стоимость -->
                                            <Grid Grid.Row="3" Margin="0,0,0,12">
                                                <TextBlock Text="Стоимость:" 
                                                           FontSize="13" 
                                                           Foreground="#888888" 
                                                           VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding TotalPrice, StringFormat={}{0:C}, ConverterCulture=ru-RU}" 
                                                           FontSize="26" 
                                                           FontWeight="Bold" 
                                                           Foreground="#FFC107" 
                                                           HorizontalAlignment="Right"
                                                           VerticalAlignment="Center"/>
                                            </Grid>

                                            <!-- Кнопки Принять/Отклонить -->
                                            <Grid Grid.Row="4">
                                                <Grid.Style>
                                                    <Style TargetType="Grid">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Grid.Style>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="10"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <Button Grid.Column="0" 
                                                        Content="✓ ПРИНЯТЬ" 
                                                        Command="{Binding DataContext.AcceptOrderCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource AcceptButton}" 
                                                        Padding="15,12"
                                                        FontSize="14"/>
                                                <Button Grid.Column="2" 
                                                        Content="✕" 
                                                        Command="{Binding DataContext.DeclineOrderCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                        CommandParameter="{Binding}"
                                                        Width="45"
                                                        Height="45"
                                                        Background="#FFE5E5"
                                                        Foreground="#DC3545"
                                                        FontSize="18"
                                                        FontWeight="Bold"
                                                        BorderThickness="0"
                                                        Cursor="Hand">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}" CornerRadius="10">
                                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background" Value="#DC3545"/>
                                                                                <Setter Property="Foreground" Value="White"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Панель информации о принятом заказе (слева) -->
            <Border x:Name="AcceptedOrderPanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Stretch"
                    Width="420"
                    Margin="15,50,0,15"
                    Visibility="{Binding IsOnOrder, Converter={StaticResource BooleanToVisibilityConverter}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2">
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRatingClient}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Border.Effect>
                    <DropShadowEffect BlurRadius="25" ShadowDepth="5" Opacity="0.3" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок -->
                    <Border Grid.Row="0" Background="#FFF8E1" CornerRadius="20,20,0,0" Padding="20,15">
                        <StackPanel>
                            <TextBlock FontSize="14" Foreground="#888888" Margin="0,0,0,5">
                                <Run Text="🚕 ЗАКАЗ #"/>
                                <Run Text="{Binding AcceptedOrder.order_id}"/>
                            </TextBlock>
                            <TextBlock Text="{Binding AcceptedOrder.TotalPrice, StringFormat={}{0:C}, ConverterCulture=ru-RU}" 
                                       FontSize="32" 
                                       FontWeight="Bold" 
                                       Foreground="#FFC107"/>
                        </StackPanel>
                    </Border>

                    <!-- Детали заказа -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20">
                        <StackPanel>
                            <!-- Клиент -->
                            <Border Background="#F5F5F5" CornerRadius="12" Padding="15" Margin="0,0,0,15">
                                <Grid>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="👤" FontSize="20" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                        <StackPanel>
                                            <TextBlock Text="{Binding AcceptedOrder.OrderClient.full_name}" 
                                                       FontSize="16" 
                                                       FontWeight="SemiBold" 
                                                       Foreground="#333333"/>
                                            <StackPanel Orientation="Horizontal" Margin="0,3,0,0">
                                                <TextBlock Text="⭐" Foreground="#FFC107" FontSize="12"/>
                                                <TextBlock Text="{Binding AcceptedOrder.OrderClient.rating, StringFormat=F1}" 
                                                           FontSize="12" 
                                                           Foreground="#666666" 
                                                           Margin="3,0,0,0"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <!-- Откуда -->
                            <StackPanel Margin="0,0,0,12">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <Border Background="#E8F5E9" CornerRadius="5" Padding="8,4" Margin="0,0,10,0">
                                        <TextBlock Text="ОТКУДА" FontWeight="Bold" Foreground="#28A745" FontSize="10"/>
                                    </Border>
                                </StackPanel>
                                <TextBlock Text="{Binding AcceptedOrder.PointA}" 
                                           FontSize="15" 
                                           Foreground="#333333" 
                                           TextWrapping="Wrap"/>
                            </StackPanel>

                            <!-- Куда -->
                            <StackPanel Margin="0,0,0,20">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                    <Border Background="#FFEBEE" CornerRadius="5" Padding="8,4" Margin="0,0,10,0">
                                        <TextBlock Text="КУДА" FontWeight="Bold" Foreground="#DC3545" FontSize="10"/>
                                    </Border>
                                </StackPanel>
                                <TextBlock Text="{Binding AcceptedOrder.PointB}" 
                                           FontSize="15" 
                                           Foreground="#333333" 
                                           TextWrapping="Wrap"/>
                            </StackPanel>

                            <!-- Тариф -->
                            <Border Background="#F0F0F0" CornerRadius="8" Padding="12" Margin="0,0,0,25">
                                <Grid>
                                    <TextBlock Text="Тариф:" FontSize="13" Foreground="#888888" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding AcceptedOrder.Tariff}" 
                                               FontSize="14" 
                                               FontWeight="SemiBold" 
                                               Foreground="#333333" 
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </Border>

                            <!-- Кнопки действий -->
                            <Button Content="📍 Я ПРИБЫЛ" 
                                    Command="{Binding ArrivedCommand}" 
                                    Style="{StaticResource AcceptButton}" 
                                    Padding="15,15"
                                    FontSize="16"
                                    Margin="0,0,0,10"
                                    Visibility="{Binding CanShowArrived, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            
                            <Button Content="▶ НАЧАТЬ ПОЕЗДКУ" 
                                    Command="{Binding StartTripCommand}" 
                                    Style="{StaticResource PrimaryButton}" 
                                    Padding="15,15"
                                    FontSize="16"
                                    Margin="0,0,0,10"
                                    Visibility="{Binding CanShowStartTrip, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            
                            <Button Content="✓ ЗАВЕРШИТЬ ЗАКАЗ" 
                                    Command="{Binding CompleteOrderCommand}" 
                                    Padding="15,15"
                                    FontSize="16"
                                    Background="#28A745"
                                    Foreground="White"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    Visibility="{Binding CanShowCompleteTrip, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="10">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#218838"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Панель оценки клиента -->
            <Border x:Name="RatingPanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="30"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="400"
                    Visibility="{Binding IsRatingClient, Converter={StaticResource BooleanToVisibilityConverter}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="1000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="40" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="⭐ Оцените клиента" 
                               FontSize="24" 
                               FontWeight="Bold" 
                               Margin="0,0,0,10" 
                               Foreground="#333333"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding AcceptedOrder.OrderClient.full_name}" 
                               FontSize="16" 
                               Foreground="#666666" 
                               Margin="0,0,0,25"
                               HorizontalAlignment="Center"/>

                    <!-- Звёзды рейтинга -->
                    <StackPanel Orientation="Horizontal" 
                                Margin="0,0,0,25" 
                                HorizontalAlignment="Center">
                        <RadioButton x:Name="Star1" GroupName="ClientRating" Tag="1" Content="★" FontSize="40" 
                                     Checked="DriverRatingButton_Checked" 
                                     Cursor="Hand" Margin="5,0" Foreground="#E0E0E0">
                            <RadioButton.Template>
                                <ControlTemplate TargetType="RadioButton">
                                    <TextBlock Text="{TemplateBinding Content}" 
                                               FontSize="{TemplateBinding FontSize}" 
                                               Foreground="{TemplateBinding Foreground}"/>
                                </ControlTemplate>
                            </RadioButton.Template>
                        </RadioButton>

                        <RadioButton x:Name="Star2" GroupName="ClientRating" Tag="2" Content="★" FontSize="40" 
                                     Checked="DriverRatingButton_Checked" 
                                     Cursor="Hand" Margin="5,0" Foreground="#E0E0E0">
                            <RadioButton.Template>
                                <ControlTemplate TargetType="RadioButton">
                                    <TextBlock Text="{TemplateBinding Content}" 
                                               FontSize="{TemplateBinding FontSize}" 
                                               Foreground="{TemplateBinding Foreground}"/>
                                </ControlTemplate>
                            </RadioButton.Template>
                        </RadioButton>

                        <RadioButton x:Name="Star3" GroupName="ClientRating" Tag="3" Content="★" FontSize="40" 
                                     Checked="DriverRatingButton_Checked" 
                                     Cursor="Hand" Margin="5,0" Foreground="#E0E0E0">
                            <RadioButton.Template>
                                <ControlTemplate TargetType="RadioButton">
                                    <TextBlock Text="{TemplateBinding Content}" 
                                               FontSize="{TemplateBinding FontSize}" 
                                               Foreground="{TemplateBinding Foreground}"/>
                                </ControlTemplate>
                            </RadioButton.Template>
                        </RadioButton>

                        <RadioButton x:Name="Star4" GroupName="ClientRating" Tag="4" Content="★" FontSize="40" 
                                     Checked="DriverRatingButton_Checked" 
                                     Cursor="Hand" Margin="5,0" Foreground="#E0E0E0">
                            <RadioButton.Template>
                                <ControlTemplate TargetType="RadioButton">
                                    <TextBlock Text="{TemplateBinding Content}" 
                                               FontSize="{TemplateBinding FontSize}" 
                                               Foreground="{TemplateBinding Foreground}"/>
                                </ControlTemplate>
                            </RadioButton.Template>
                        </RadioButton>

                        <RadioButton x:Name="Star5" GroupName="ClientRating" Tag="5" Content="★" FontSize="40" 
                                     Checked="DriverRatingButton_Checked" 
                                     Cursor="Hand" Margin="5,0" Foreground="#E0E0E0">
                            <RadioButton.Template>
                                <ControlTemplate TargetType="RadioButton">
                                    <TextBlock Text="{TemplateBinding Content}" 
                                               FontSize="{TemplateBinding FontSize}" 
                                               Foreground="{TemplateBinding Foreground}"/>
                                </ControlTemplate>
                            </RadioButton.Template>
                        </RadioButton>
                    </StackPanel>

                    <Button Content="ОТПРАВИТЬ ОЦЕНКУ" 
                            Command="{Binding RateClientCommand}" 
                            Style="{StaticResource PrimaryButton}" 
                            Padding="20,15"
                            FontSize="16"
                            Margin="0,0,0,10"/>
                    
                    <Button Content="Пропустить" 
                            Command="{Binding SkipRateClientCommand}"
                            Padding="15,10"
                            Background="#F5F5F5"
                            Foreground="#666666"
                            BorderThickness="0"
                            Cursor="Hand"
                            FontSize="14">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}" CornerRadius="8">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#E8E8E8"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Border>

            <!-- Плавающая панель профиля водителя (справа) -->
            <Border x:Name="ProfilePanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="0"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Stretch"
                    Width="400"
                    Margin="0,10,10,10"
                    Visibility="{Binding IsProfilePanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="1000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Заголовок профиля -->
                    <Border Grid.Row="0" 
                            Background="#F5F5F5" 
                            CornerRadius="20,20,0,0" 
                            Padding="20,15">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Аватар -->
                            <Border Grid.Column="0" 
                                    Width="50" 
                                    Height="50" 
                                    CornerRadius="25" 
                                    BorderBrush="#FFC107" 
                                    BorderThickness="2"
                                    Margin="0,0,12,0">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding CurrentDriver.DriverPhotoUrl, Converter={StaticResource PathToImageConverter}}" Stretch="UniformToFill"/>
                                </Border.Background>
                            </Border>
                            
                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock Text="{Binding CurrentDriver.full_name}" 
                                           FontSize="16" 
                                           FontWeight="Bold" 
                                           Foreground="#333333"/>
                                <StackPanel Orientation="Horizontal" Margin="0,3,0,0">
                                    <TextBlock Text="⭐" Foreground="#FFC107" FontSize="14" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding CurrentDriver.rating, StringFormat=F2, FallbackValue='N/A'}" 
                                               FontSize="14" 
                                               FontWeight="SemiBold" 
                                               Foreground="#333333" 
                                               Margin="4,0,0,0"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Кнопка закрытия -->
                            <Button Grid.Column="2" 
                                    Content="✕" 
                                    Command="{Binding ToggleProfilePanelCommand}"
                                    Width="30" 
                                    Height="30"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Foreground="#666"
                                    FontSize="16"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="15">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#E0E0E0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <!-- Содержимое профиля -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20,15,20,20">
                        <StackPanel>
                            <!-- Баланс -->
                            <Border Background="#FFF8E1" CornerRadius="12" Padding="15" Margin="0,0,0,20">
                                <Grid>
                                    <TextBlock Text="💰 Баланс:" FontSize="14" Foreground="#888888" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding CurrentDriver.Balance, StringFormat={}{0:C}, ConverterCulture=ru-RU, FallbackValue='0 ₽'}" 
                                               FontSize="22" 
                                               FontWeight="Bold" 
                                               Foreground="#FFC107" 
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </Border>

                            <!-- Кнопки -->
                            <Button Content="🏠 В личный кабинет" 
                                    Command="{Binding GoToDashboardCommand}" 
                                    Style="{StaticResource PrimaryButton}" 
                                    Padding="15,12"
                                    FontSize="14"
                                    Margin="0,0,0,10"/>

                            <Button Content="💬 Связаться с поддержкой" 
                                    Command="{Binding ContactSupportCommand}" 
                                    Style="{StaticResource DeclineButton}" 
                                    Padding="15,12"
                                    FontSize="14"/>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
