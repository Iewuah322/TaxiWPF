<Window x:Class="TaxiWPF.Views.ManagerView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        Title="Панель Менеджера" Height="720" Width="1280"
        WindowStartupLocation="CenterScreen" MinWidth="1000" MinHeight="600"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        FontFamily="Segoe UI"
        MouseLeftButtonDown="Window_MouseLeftButtonDown">

    <Border Background="#F0EEE9" CornerRadius="10" BorderBrush="#8D837C" BorderThickness="1">
        <Grid>
            <!-- Кнопка профиля слева -->
            <Button Command="{Binding ToggleProfilePanelCommand}" 
                    Style="{StaticResource AvatarButton}" 
                    HorizontalAlignment="Left" 
                    VerticalAlignment="Top" 
                    Margin="10,5,0,0" 
                    Panel.ZIndex="100">
                <Grid Width="30" Height="30">
                    <TextBlock Text="👤" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </Grid>
            </Button>

            <!-- Кнопка закрытия -->
            <Button Content="✕" Click="CloseButton_Click" Style="{StaticResource CloseButton}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,5,0" Panel.ZIndex="100"/>

            <!-- Основной контент -->
            <Grid Margin="40,50,40,50">
                <Border Background="#FFFFFF" 
                        Opacity="0.98"
                        CornerRadius="25" 
                        Padding="0"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        BorderBrush="#E0E0E0"
                        BorderThickness="2">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="30" ShadowDepth="8" Opacity="0.25" Color="Black"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Заголовок -->
                        <Border Grid.Row="0" Background="#F8F8F8" CornerRadius="25,25,0,0" Padding="30,20">
                            <Grid>
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="👨‍💼" FontSize="28" Margin="0,0,15,0" VerticalAlignment="Center"/>
                                        <TextBlock Text="ПАНЕЛЬ МЕНЕДЖЕРА" 
                                                   FontSize="24" 
                                                   FontWeight="Bold" 
                                                   Foreground="#333333"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <TextBlock Text="Управление обращениями в поддержку" 
                                               FontSize="14" 
                                               Foreground="#888888" 
                                               Margin="0,8,0,0"/>
                                </StackPanel>

                                <Button Command="{Binding RefreshTicketsCommand}" 
                                        Content="🔄 Обновить" 
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center"
                                        Padding="20,10"
                                        FontSize="14"
                                        Background="#E3F2FD"
                                        Foreground="#1976D2"
                                        BorderThickness="0"
                                        Cursor="Hand">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                CornerRadius="10"
                                                                Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#1976D2"/>
                                                                <Setter Property="Foreground" Value="White"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Список обращений -->
                        <Grid Grid.Row="1" Margin="30,25">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" 
                                       Text="💬 Активные обращения в поддержку" 
                                       FontSize="18" 
                                       FontWeight="Bold" 
                                       Foreground="#333333" 
                                       Margin="0,0,0,20"/>

                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                <ListBox ItemsSource="{Binding OpenTickets}" 
                                         SelectedItem="{Binding SelectedTicket, Mode=TwoWay}"
                                         BorderThickness="0"
                                         Background="Transparent"
                                         SelectionMode="Single">
                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ListBoxItem">
                                                        <ContentPresenter/>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Setter Property="Margin" Value="0,0,0,15"/>
                                            <Setter Property="Padding" Value="0"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="White" 
                                                    CornerRadius="15" 
                                                    Padding="20" 
                                                    BorderBrush="#E8E8E8" 
                                                    BorderThickness="1"
                                                    Cursor="Hand">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                                <Setter Property="Background" Value="#FFFDF5"/>
                                                                <Setter Property="BorderBrush" Value="#FFC107"/>
                                                                <Setter Property="BorderThickness" Value="2"/>
                                                            </DataTrigger>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#FAFAFA"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <Border.Effect>
                                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.1" Color="Black"/>
                                                </Border.Effect>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                        <TextBlock FontSize="16" 
                                                                   FontWeight="SemiBold" 
                                                                   Text="{Binding Subject}" 
                                                                   TextTrimming="CharacterEllipsis"
                                                                   Foreground="#333333"
                                                                   Margin="0,0,0,8"/>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="👤" FontSize="12" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                                            <TextBlock Foreground="#666666" FontSize="13">
                                                                <Run Text="От: "/>
                                                                <Run Text="{Binding UserInfo.full_name}" FontWeight="SemiBold"/>
                                                                <Run Text=" ("/>
                                                                <Run Text="{Binding UserInfo.username}"/>
                                                                <Run Text=")"/>
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </StackPanel>

                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" HorizontalAlignment="Right">
                                                        <TextBlock Text="{Binding LastUpdated, StringFormat='dd.MM.yyyy'}"
                                                                   Foreground="#888888" 
                                                                   FontSize="12"
                                                                   HorizontalAlignment="Right"/>
                                                        <TextBlock Text="{Binding LastUpdated, StringFormat='HH:mm'}"
                                                                   Foreground="#888888" 
                                                                   FontSize="12"
                                                                   HorizontalAlignment="Right"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </ScrollViewer>
                        </Grid>

                        <!-- Нижняя панель -->
                        <Border Grid.Row="2" Background="#F8F8F8" CornerRadius="0,0,25,25" Padding="30,20">
                            <Button Content="💬 Открыть выбранный чат" 
                                    Command="{Binding OpenChatCommand}"
                                    Style="{StaticResource AcceptButton}" 
                                    Padding="30,15"
                                    FontSize="16"
                                    HorizontalAlignment="Right"
                                    IsEnabled="{Binding SelectedTicket, Converter={StaticResource StringToVisibilityConverter}}"/>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- Плавающая панель профиля менеджера (справа) -->
            <Border x:Name="ProfilePanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="0"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Stretch"
                    Width="400"
                    Margin="0,10,10,10"
                    Visibility="{Binding IsProfilePanelVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="1000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Заголовок профиля -->
                    <Border Grid.Row="0" 
                            Background="#F5F5F5" 
                            CornerRadius="20,20,0,0" 
                            Padding="20,15">
                        <Grid>
                            <StackPanel Orientation="Horizontal">
                                <Border Width="50" 
                                        Height="50" 
                                        CornerRadius="25" 
                                        Background="#FFC107" 
                                        Margin="0,0,12,0">
                                    <TextBlock Text="👨‍💼" 
                                               FontSize="24" 
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"/>
                                </Border>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="{Binding CurrentManager.full_name}" 
                                               FontSize="16" 
                                               FontWeight="Bold" 
                                               Foreground="#333333"/>
                                    <TextBlock Text="Менеджер" 
                                               FontSize="13" 
                                               Foreground="#888888"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Кнопка закрытия -->
                            <Button Content="✕" 
                                    Command="{Binding ToggleProfilePanelCommand}"
                                    Width="30" 
                                    Height="30"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Foreground="#666"
                                    FontSize="16"
                                    Cursor="Hand"
                                    HorizontalAlignment="Right">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="15">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#E0E0E0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <!-- Содержимое профиля -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="20,15,20,20">
                        <StackPanel>
                            <TextBlock Text="📧 Email:" 
                                       FontSize="13" 
                                       Foreground="#888888" 
                                       Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding CurrentManager.email}" 
                                       FontSize="14" 
                                       Foreground="#333333" 
                                       Margin="0,0,0,20"/>
                            
                            <TextBlock Text="📱 Телефон:" 
                                       FontSize="13" 
                                       Foreground="#888888" 
                                       Margin="0,0,0,5"/>
                            <TextBlock Text="{Binding CurrentManager.phone, FallbackValue='Не указан'}" 
                                       FontSize="14" 
                                       Foreground="#333333" 
                                       Margin="0,0,0,20"/>
                            
                            <Border Background="#FFF8E1" 
                                    CornerRadius="12" 
                                    Padding="15" 
                                    Margin="0,10,0,0">
                                <StackPanel>
                                    <TextBlock Text="📊 Статистика" 
                                               FontSize="14" 
                                               FontWeight="SemiBold" 
                                               Foreground="#333333" 
                                               Margin="0,0,0,10"/>
                                    <TextBlock FontSize="13" Foreground="#666666">
                                        <Run Text="Активных обращений: "/>
                                        <Run Text="{Binding OpenTickets.Count, Mode=OneWay, FallbackValue=0}" FontWeight="SemiBold" Foreground="#FFC107"/>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
