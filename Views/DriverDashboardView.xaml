<Window x:Class="TaxiWPF.Views.DriverDashboardView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:TaxiWPF.ViewModels"
        xmlns:converters="clr-namespace:TaxiWPF.Converters"
        Title="Личный кабинет водителя" Height="720" Width="1280"
        WindowStartupLocation="CenterScreen" MinWidth="1280" MinHeight="720"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        FontFamily="Segoe UI" MouseLeftButtonDown="Window_MouseLeftButtonDown">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </Window.Resources>

    <Border Background="#F0EEE9" CornerRadius="10" BorderBrush="#8D837C" BorderThickness="1">
        <Grid>
            <!-- Кнопка профиля слева -->
            <Button Command="{Binding ToggleProfilePanelCommand}" Style="{StaticResource AvatarButton}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20,15,0,0" Panel.ZIndex="100">
                <Grid Width="30" Height="30">
                    <TextBlock Text="👤" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                    <Ellipse>
                        <Ellipse.Fill>
                            <ImageBrush ImageSource="{Binding CurrentUser.DriverPhotoUrl, Converter={StaticResource PathToImageConverter}}"/>
                        </Ellipse.Fill>
                    </Ellipse>
                </Grid>
            </Button>
            
            <!-- Кнопка закрытия -->
            <Button Content="✕" Click="CloseButton_Click" Style="{StaticResource CloseButton}" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,5,5,0" Panel.ZIndex="100"/>

            <!-- Основной контент по центру -->
            <Grid Margin="80,50,80,50">
                <!-- Центральная панель с балансом и статистикой -->
                <Border Background="#FFFFFF" 
                        Opacity="0.95"
                        CornerRadius="25" 
                        Padding="0"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        BorderBrush="#E0E0E0"
                        BorderThickness="2">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="30" ShadowDepth="8" Opacity="0.25" Color="Black"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="380"/>
                        </Grid.ColumnDefinitions>

                        <!-- Левая часть - Баланс и график -->
                        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                            <StackPanel Margin="40,35,30,35">
                                <!-- Заголовок баланса -->
                                <TextBlock Text="💰 ВАШ БАЛАНС" 
                                           FontSize="14" 
                                           FontWeight="SemiBold" 
                                           Foreground="#888888" 
                                           Margin="0,0,0,8"/>
                                
                                <!-- Сумма баланса -->
                                <TextBlock Text="{Binding TotalBalance, StringFormat={}{0:C}, ConverterCulture=ru-RU}" 
                                           FontSize="56" 
                                           FontWeight="Bold" 
                                           Foreground="#333333" 
                                           Margin="0,0,0,25"/>

                                <!-- Кнопка выхода на линию -->
                                <Button Content="🚗 ВЫЙТИ НА ЛИНИЮ" 
                                        Command="{Binding GoToMapCommand}" 
                                        Style="{StaticResource PrimaryButton}" 
                                        Padding="30,18"
                                        FontSize="18"
                                        HorizontalAlignment="Left"
                                        Margin="0,0,0,40"/>

                                <!-- График заработка -->
                                <TextBlock Text="📊 ЗАРАБОТОК ЗА 7 ДНЕЙ" 
                                           FontSize="16" 
                                           FontWeight="Bold" 
                                           Foreground="#333333" 
                                           Margin="0,0,0,20"/>
                                
                                <Border Background="#FAFAFA" 
                                        CornerRadius="15" 
                                        Padding="25,20" 
                                        BorderBrush="#E8E8E8" 
                                        BorderThickness="1"
                                        Margin="0,0,0,25">
                                    <Grid Height="200">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Оси Y -->
                                        <ItemsControl Grid.Column="0" ItemsSource="{Binding YAxisLabels}" Margin="0,0,10,30">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="*"/>
                                                            <RowDefinition Height="*"/>
                                                        </Grid.RowDefinitions>
                                                    </Grid>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" FontSize="11" Foreground="#888" VerticalAlignment="Top" HorizontalAlignment="Right"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Столбцы графика -->
                                        <Border Grid.Column="1" Padding="10,0,0,0" Margin="0,0,0,30">
                                            <ItemsControl ItemsSource="{Binding DailyEarnings}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Bottom" HorizontalAlignment="Center"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel HorizontalAlignment="Center" Margin="12,0" VerticalAlignment="Bottom">
                                                            <Border Background="#FFC107" 
                                                                    Width="35" 
                                                                    Height="{Binding ScaledHeight}" 
                                                                    CornerRadius="5,5,0,0"
                                                                    Cursor="Hand">
                                                                <Border.ToolTip>
                                                                    <ToolTip>
                                                                        <TextBlock Text="{Binding Value, StringFormat={}{0:C}, ConverterCulture=ru-RU}" FontWeight="SemiBold"/>
                                                                    </ToolTip>
                                                                </Border.ToolTip>
                                                            </Border>
                                                            <TextBlock Text="{Binding Label}" 
                                                                       FontSize="12" 
                                                                       FontWeight="SemiBold" 
                                                                       HorizontalAlignment="Center" 
                                                                       Foreground="#555" 
                                                                       Margin="0,8,0,0"/>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Border>
                                    </Grid>
                                </Border>

                                <!-- Панель вывода средств -->
                                <Border Background="#FFFDF5" 
                                        CornerRadius="15" 
                                        Padding="25" 
                                        BorderBrush="#FFC107" 
                                        BorderThickness="2"
                                        Visibility="{Binding IsWithdrawPanelVisible, Converter={StaticResource BoolToVis}}">
                                    <StackPanel>
                                        <TextBlock Text="💳 Вывод средств" 
                                                   FontSize="20" 
                                                   FontWeight="Bold" 
                                                   Margin="0,0,0,20" 
                                                   Foreground="#333"/>
                                        
                                        <TextBlock Text="Сумма для вывода" Style="{StaticResource InputLabel}"/>
                                        <TextBox Text="{Binding WithdrawAmount, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" 
                                                 Style="{StaticResource InputField}"
                                                 Margin="0,0,0,5"/>
                                        <TextBlock Text="{Binding AmountError}" 
                                                   Foreground="#DC3545" 
                                                   FontSize="12" 
                                                   Margin="0,0,0,10" 
                                                   Visibility="{Binding AmountError, Converter={StaticResource StringToVisibilityConverter}}"/>
                                        
                                        <TextBlock Text="Номер карты" Style="{StaticResource InputLabel}"/>
                                        <TextBox Text="{Binding CardNumber, UpdateSourceTrigger=PropertyChanged}" 
                                                 Style="{StaticResource InputField}"
                                                 Margin="0,0,0,5"/>
                                        <TextBlock Text="{Binding CardNumberError}" 
                                                   Foreground="#DC3545" 
                                                   FontSize="12" 
                                                   Margin="0,0,0,10" 
                                                   Visibility="{Binding CardNumberError, Converter={StaticResource StringToVisibilityConverter}}"/>
                                        
                                        <Grid Margin="0,0,0,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="20"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="Срок (MM/YY)" Style="{StaticResource InputLabel}"/>
                                                <TextBox Text="{Binding CardExpiry, UpdateSourceTrigger=PropertyChanged}" 
                                                         Style="{StaticResource InputField}"/>
                                                <TextBlock Text="{Binding CardExpiryError}" 
                                                           Foreground="#DC3545" 
                                                           FontSize="12" 
                                                           Visibility="{Binding CardExpiryError, Converter={StaticResource StringToVisibilityConverter}}"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2">
                                                <TextBlock Text="CVV" Style="{StaticResource InputLabel}"/>
                                                <TextBox Text="{Binding CardCVV, UpdateSourceTrigger=PropertyChanged}" 
                                                         Style="{StaticResource InputField}"/>
                                                <TextBlock Text="{Binding CvvError}" 
                                                           Foreground="#DC3545" 
                                                           FontSize="12" 
                                                           Visibility="{Binding CvvError, Converter={StaticResource StringToVisibilityConverter}}"/>
                                            </StackPanel>
                                        </Grid>
                                        
                                        <CheckBox Content="Запомнить карту" 
                                                  IsChecked="{Binding RememberCard}" 
                                                  Margin="0,10,0,20" 
                                                  Foreground="#4F4A45"
                                                  FontSize="14"/>
                                        
                                        <Button Content="✓ ПОДТВЕРДИТЬ ВЫВОД" 
                                                Command="{Binding WithdrawCommand}" 
                                                Style="{StaticResource AcceptButton}"
                                                Padding="20,12"
                                                FontSize="14"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <!-- Правая панель - История операций -->
                        <Border Grid.Column="1" 
                                Background="#FAFAFA" 
                                CornerRadius="0,23,23,0" 
                                BorderBrush="#E8E8E8" 
                                BorderThickness="1,0,0,0">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="25,35,25,25">
                                    <!-- Кнопка вывода -->
                                    <Button Content="💸 Вывести средства" 
                                            Command="{Binding ToggleWithdrawPanelCommand}" 
                                            Style="{StaticResource DeclineButton}" 
                                            Padding="15,12"
                                            FontSize="14"
                                            Margin="0,0,0,25"/>

                                    <!-- Выбор сохранённой карты -->
                                    <TextBlock Text="💳 СОХРАНЁННЫЕ КАРТЫ" 
                                               FontSize="13" 
                                               FontWeight="Bold" 
                                               Foreground="#666666" 
                                               Margin="0,0,0,10"/>
                                    <Grid Margin="0,0,0,25">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ComboBox Grid.Column="0" 
                                                  ItemsSource="{Binding SavedCards}" 
                                                  SelectedItem="{Binding SelectedSavedCard}" 
                                                  DisplayMemberPath="MaskedName" 
                                                  Style="{StaticResource CustomComboBox}"/>
                                        <Button Grid.Column="1" 
                                                Content="🗑" 
                                                Command="{Binding DeleteCardCommand}" 
                                                Width="40" 
                                                Height="40" 
                                                Margin="8,0,0,0"
                                                Background="#F5F5F5"
                                                BorderBrush="#E0E0E0"
                                                BorderThickness="1"
                                                Cursor="Hand">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" 
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                                        CornerRadius="8">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="#FFE5E5"/>
                                                                        <Setter Property="BorderBrush" Value="#DC3545"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </Grid>

                                    <!-- Последние поступления -->
                                    <TextBlock Text="📈 ПОСЛЕДНИЕ ПОСТУПЛЕНИЯ" 
                                               FontSize="13" 
                                               FontWeight="Bold" 
                                               Foreground="#666666" 
                                               Margin="0,0,0,15"/>
                                    <ItemsControl ItemsSource="{Binding RecentEarnings}" Margin="0,0,0,25">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="White" 
                                                        CornerRadius="10" 
                                                        Padding="15" 
                                                        Margin="0,0,0,8" 
                                                        BorderBrush="#E8E8E8" 
                                                        BorderThickness="1">
                                                    <Grid>
                                                        <StackPanel VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Description}" 
                                                                       FontWeight="SemiBold" 
                                                                       Foreground="#28A745"
                                                                       FontSize="14"/>
                                                            <TextBlock Text="{Binding Date, StringFormat={}{dd.MM.yyyy HH:mm}}" 
                                                                       FontSize="11" 
                                                                       Foreground="#999999"/>
                                                        </StackPanel>
                                                        <TextBlock Text="{Binding Amount, StringFormat='+{0:C}', ConverterCulture=ru-RU}" 
                                                                   FontWeight="Bold" 
                                                                   FontSize="16"
                                                                   VerticalAlignment="Center" 
                                                                   HorizontalAlignment="Right" 
                                                                   Foreground="#28A745"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Последние выводы -->
                                    <TextBlock Text="📉 ПОСЛЕДНИЕ ВЫВОДЫ" 
                                               FontSize="13" 
                                               FontWeight="Bold" 
                                               Foreground="#666666" 
                                               Margin="0,0,0,15"/>
                                    <ItemsControl ItemsSource="{Binding RecentWithdrawals}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="White" 
                                                        CornerRadius="10" 
                                                        Padding="15" 
                                                        Margin="0,0,0,8" 
                                                        BorderBrush="#E8E8E8" 
                                                        BorderThickness="1">
                                                    <Grid>
                                                        <StackPanel VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Description}" 
                                                                       FontWeight="SemiBold" 
                                                                       Foreground="#DC3545"
                                                                       FontSize="14"/>
                                                            <TextBlock Text="{Binding Date, StringFormat={}{dd.MM.yyyy HH:mm}}" 
                                                                       FontSize="11" 
                                                                       Foreground="#999999"/>
                                                        </StackPanel>
                                                        <TextBlock Text="{Binding Amount, StringFormat={}{0:C}, ConverterCulture=ru-RU}" 
                                                                   FontWeight="Bold" 
                                                                   FontSize="16"
                                                                   VerticalAlignment="Center" 
                                                                   HorizontalAlignment="Right" 
                                                                   Foreground="#DC3545"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <!-- Плавающая панель профиля (справа, как у клиента) -->
            <Border x:Name="ProfilePanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="20" 
                    Padding="0"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Stretch"
                    Width="450"
                    Margin="0,10,10,10"
                    Visibility="{Binding IsProfilePanelVisible, Converter={StaticResource BoolToVis}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="1000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="30" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Заголовок профиля -->
                    <Border Grid.Row="0" 
                            Background="#F5F5F5" 
                            CornerRadius="20,20,0,0" 
                            Padding="25,20">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Аватар -->
                            <Border Grid.Column="0" 
                                    Width="60" 
                                    Height="60" 
                                    CornerRadius="30" 
                                    BorderBrush="#FFC107" 
                                    BorderThickness="3"
                                    Margin="0,0,15,0">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding CurrentUser.DriverPhotoUrl, Converter={StaticResource PathToImageConverter}}" Stretch="UniformToFill"/>
                                </Border.Background>
                            </Border>
                            
                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock Text="{Binding CurrentUser.full_name}" 
                                           FontSize="20" 
                                           FontWeight="Bold" 
                                           Foreground="#333333"/>
                                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                    <TextBlock Text="⭐" Foreground="#FFC107" FontSize="16" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding CurrentUser.rating, StringFormat=F2, FallbackValue='N/A'}" 
                                               FontSize="16" 
                                               FontWeight="SemiBold" 
                                               Foreground="#333333" 
                                               Margin="5,0,0,0"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <!-- Кнопка закрытия -->
                            <Button Grid.Column="2" 
                                    Content="✕" 
                                    Command="{Binding ToggleProfilePanelCommand}"
                                    Width="35" 
                                    Height="35"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Foreground="#666"
                                    FontSize="18"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="17.5">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#E0E0E0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                    
                    <!-- Содержимое профиля -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="25,20,25,25">
                        <StackPanel>
                            <!-- Фото профиля -->
                            <TextBlock Text="📷 ФОТО ПРОФИЛЯ" 
                                       FontSize="13" 
                                       FontWeight="Bold" 
                                       Foreground="#666666" 
                                       Margin="0,0,0,10"/>
                            <Border Background="#F5F5F5" 
                                    CornerRadius="15" 
                                    Height="150" 
                                    Margin="0,0,0,10"
                                    BorderBrush="#E0E0E0"
                                    BorderThickness="1">
                                <Image Source="{Binding CurrentUser.DriverPhotoUrl, Converter={StaticResource PathToImageConverter}}" 
                                       Stretch="Uniform"/>
                            </Border>
                            <Button Content="📤 Обновить фото профиля" 
                                    Command="{Binding UpdateProfilePhotoCommand}" 
                                    Style="{StaticResource PrimaryButton}" 
                                    Padding="15,10"
                                    FontSize="14"
                                    Margin="0,0,0,25"/>

                            <!-- Фото прав -->
                            <TextBlock Text="🪪 ФОТО ПРАВ" 
                                       FontSize="13" 
                                       FontWeight="Bold" 
                                       Foreground="#666666" 
                                       Margin="0,0,0,10"/>
                            <Border Background="#F5F5F5" 
                                    CornerRadius="15" 
                                    Height="150" 
                                    Margin="0,0,0,10"
                                    BorderBrush="#E0E0E0"
                                    BorderThickness="1">
                                <Image Source="{Binding CurrentUser.LicensePhotoPath, Converter={StaticResource PathToImageConverter}}" 
                                       Stretch="Uniform"/>
                            </Border>
                            <Button Content="📤 Обновить фото прав" 
                                    Command="{Binding UpdateLicensePhotoCommand}" 
                                    Style="{StaticResource PrimaryButton}" 
                                    Padding="15,10"
                                    FontSize="14"
                                    Margin="0,0,0,30"/>

                            <!-- Кнопка поддержки -->
                            <Button Content="💬 Связаться с поддержкой" 
                                    Command="{Binding ContactSupportCommand}" 
                                    Style="{StaticResource DeclineButton}" 
                                    Padding="15,12"
                                    FontSize="14"/>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Панель выбора автомобиля (поверх всего) -->
            <Border x:Name="CarSelectionPanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="25" 
                    Padding="0"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="900"
                    MaxHeight="700"
                    Visibility="{Binding IsCarSelectionVisible, Converter={StaticResource BoolToVis}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="2000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="40" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок -->
                    <Border Grid.Row="0" Background="#F8F8F8" CornerRadius="25,25,0,0" Padding="30,20">
                        <Grid>
                            <TextBlock Text="🚗 ВЫБЕРИТЕ АВТОМОБИЛЬ" 
                                       FontSize="24" 
                                       FontWeight="Bold" 
                                       Foreground="#333333"
                                       VerticalAlignment="Center"/>
                            <Button Content="✕" 
                                    Command="{Binding CloseCarSelectionCommand}"
                                    HorizontalAlignment="Right"
                                    Width="35" 
                                    Height="35"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Foreground="#666"
                                    FontSize="18"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="17.5">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#E0E0E0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Список автомобилей -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="25,20">
                        <ItemsControl ItemsSource="{Binding Cars}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <UniformGrid Columns="3" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="10" 
                                            Padding="0" 
                                            CornerRadius="20" 
                                            Width="250"
                                            Cursor="Hand"
                                            BorderThickness="3"
                                            MouseLeftButtonDown="CarCard_MouseLeftButtonDown">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="#FAFAFA"/>
                                                <Setter Property="BorderBrush" Value="#E8E8E8"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter Property="Background" Value="#FFFDF5"/>
                                                        <Setter Property="BorderBrush" Value="#FFC107"/>
                                                    </DataTrigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#F5F5F5"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="15" ShadowDepth="3" Opacity="0.15" Color="Black"/>
                                        </Border.Effect>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="120"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- Фото авто -->
                                            <Border Grid.Row="0" CornerRadius="20,20,0,0" Background="#F0F0F0" ClipToBounds="True">
                                                <Image Source="{Binding PhotoPath, Converter={StaticResource PathToImageConverter}}" 
                                                       Stretch="UniformToFill"
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Center">
                                                    <Image.Clip>
                                                        <RectangleGeometry Rect="0,0,250,120"/>
                                                    </Image.Clip>
                                                </Image>
                                            </Border>

                                            <!-- Галочка выбора -->
                                            <Border Grid.Row="0" 
                                                    Width="30" 
                                                    Height="30" 
                                                    CornerRadius="15" 
                                                    Background="#FFC107" 
                                                    HorizontalAlignment="Right" 
                                                    VerticalAlignment="Top" 
                                                    Margin="0,10,10,0"
                                                    Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <TextBlock Text="✓" 
                                                           FontSize="16" 
                                                           FontWeight="Bold" 
                                                           Foreground="White" 
                                                           HorizontalAlignment="Center" 
                                                           VerticalAlignment="Center"/>
                                            </Border>

                                            <!-- Информация -->
                                            <StackPanel Grid.Row="1" Margin="15,12,15,15">
                                                <TextBlock Text="{Binding ModelName}" 
                                                           FontSize="16" 
                                                           FontWeight="Bold" 
                                                           Foreground="#333333"
                                                           TextTrimming="CharacterEllipsis"/>
                                                
                                                <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                                    <Border Background="#F0F0F0" CornerRadius="5" Padding="6,3" Margin="0,0,6,0">
                                                        <TextBlock Text="{Binding LicensePlate}" 
                                                                   FontSize="11" 
                                                                   FontWeight="SemiBold" 
                                                                   Foreground="#666666"/>
                                                    </Border>
                                                    <Border CornerRadius="5" Padding="6,3">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Background" Value="#E8F5E9"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Tariff}" Value="Комфорт">
                                                                        <Setter Property="Background" Value="#E3F2FD"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Tariff}" Value="Бизнес">
                                                                        <Setter Property="Background" Value="#FFF8E1"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <TextBlock Text="{Binding Tariff}" FontSize="11" FontWeight="SemiBold">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Foreground" Value="#28A745"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding Tariff}" Value="Комфорт">
                                                                            <Setter Property="Foreground" Value="#1976D2"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding Tariff}" Value="Бизнес">
                                                                            <Setter Property="Foreground" Value="#F57C00"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Border>
                                                </StackPanel>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Нижняя панель -->
                    <Border Grid.Row="2" Background="#F8F8F8" CornerRadius="0,0,25,25" Padding="30,20">
                        <Grid>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                <Button Content="➕ Добавить авто" 
                                        Command="{Binding AddCarCommand}" 
                                        Padding="20,12"
                                        FontSize="14"
                                        Background="#E8F5E9"
                                        Foreground="#28A745"
                                        BorderThickness="0"
                                        Cursor="Hand"
                                        Margin="0,0,10,0">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                CornerRadius="12"
                                                                Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#28A745"/>
                                                                <Setter Property="Foreground" Value="White"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <Button Content="📋 Подробнее" 
                                        Command="{Binding ViewCarDetailsCommand}" 
                                        Padding="20,12"
                                        FontSize="14"
                                        Background="#F0F0F0"
                                        Foreground="#666666"
                                        BorderThickness="0"
                                        Cursor="Hand">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                CornerRadius="12"
                                                                Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#E0E0E0"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="ОТМЕНА" 
                                        Command="{Binding CloseCarSelectionCommand}" 
                                        Style="{StaticResource DeclineButton}" 
                                        Padding="25,12"
                                        FontSize="14"
                                        Margin="0,0,15,0"/>
                                <Button Content="🚗 ВЫБРАТЬ И ВЫЙТИ НА ЛИНИЮ" 
                                        Command="{Binding SelectCarCommand}" 
                                        Style="{StaticResource AcceptButton}" 
                                        Padding="30,12"
                                        FontSize="14"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>

            <!-- Панель редактирования автомобиля (поверх всего) -->
            <Border x:Name="CarDetailsPanel"
                    Background="#FFFFFF" 
                    Opacity="0.98"
                    CornerRadius="25" 
                    Padding="0"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Width="1000"
                    MaxHeight="700"
                    Visibility="{Binding IsCarDetailsVisible, Converter={StaticResource BoolToVis}}"
                    BorderBrush="#E0E0E0"
                    BorderThickness="2"
                    Panel.ZIndex="2000">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="40" ShadowDepth="10" Opacity="0.4" Color="Black"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок -->
                    <Border Grid.Row="0" Background="#F8F8F8" CornerRadius="25,25,0,0" Padding="30,20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="🚗" FontSize="28" Margin="0,0,15,0" VerticalAlignment="Center"/>
                                <TextBlock Text="ДЕТАЛИ АВТОМОБИЛЯ" 
                                           FontSize="24" 
                                           FontWeight="Bold" 
                                           Foreground="#333333"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Основной контент -->
                    <Grid Grid.Row="1" Margin="30,25">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="400"/>
                        </Grid.ColumnDefinitions>

                        <!-- Левая часть - Фото -->
                        <Grid Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Главное фото -->
                            <Border Grid.Row="0" 
                                    Background="#F5F5F5" 
                                    CornerRadius="15" 
                                    BorderBrush="#E8E8E8" 
                                    BorderThickness="2"
                                    Margin="0,0,0,15">
                                <Grid>
                                    <Image Source="{Binding CarForEditing.MainImageUrl, Converter={StaticResource PathToImageConverter}, FallbackValue='https://i.stack.imgur.com/y9DpT.jpg'}" 
                                           Stretch="Uniform"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"/>
                                </Grid>
                            </Border>

                            <!-- Галерея фото -->
                            <Border Grid.Row="1" Background="#FAFAFA" CornerRadius="12" Padding="15">
                                <StackPanel>
                                    <TextBlock Text="📸 Галерея фото" 
                                               FontSize="14" 
                                               FontWeight="SemiBold" 
                                               Foreground="#333333" 
                                               Margin="0,0,0,10"/>
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding CarForEditing.PhotoGallery}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="White" 
                                                            CornerRadius="8" 
                                                            Width="100" 
                                                            Height="100" 
                                                            Margin="0,0,10,0"
                                                            BorderBrush="#E8E8E8"
                                                            BorderThickness="1">
                                                        <Image Source="{Binding ., Converter={StaticResource PathToImageConverter}}" 
                                                               Stretch="UniformToFill"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Правая часть - Форма -->
                        <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <!-- Модель авто -->
                                <TextBlock Text="Модель авто" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <TextBox Text="{Binding CarForEditing.ModelName, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource InputField}" 
                                         Margin="0,0,0,20"/>

                                <!-- Гос. номер -->
                                <TextBlock Text="Гос. номер" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <TextBox Text="{Binding CarForEditing.LicensePlate, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource InputField}" 
                                         Margin="0,0,0,20"/>

                                <!-- Цвет -->
                                <TextBlock Text="Цвет" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <TextBox Text="{Binding CarForEditing.Color, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource InputField}" 
                                         Margin="0,0,0,20"/>

                                <!-- Тариф -->
                                <TextBlock Text="Тариф" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <ComboBox SelectedValue="{Binding CarForEditing.Tariff, UpdateSourceTrigger=PropertyChanged}" 
                                          SelectedValuePath="Content"
                                          Style="{StaticResource CustomComboBox}"
                                          Margin="0,0,0,20">
                                    <ComboBoxItem Content="Эконом"/>
                                    <ComboBoxItem Content="Комфорт"/>
                                    <ComboBoxItem Content="Бизнес"/>
                                </ComboBox>

                                <!-- Двигатель -->
                                <TextBlock Text="Двигатель" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <TextBox Text="{Binding CarForEditing.EngineInfo, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource InputField}" 
                                         Margin="0,0,0,20"/>

                                <!-- Страховка -->
                                <TextBlock Text="Страховка" Style="{StaticResource InputLabel}" Margin="0,0,0,5"/>
                                <TextBox Text="{Binding CarForEditing.InsuranceInfo, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource InputField}" 
                                         Margin="0,0,0,25"/>

                                <!-- Кнопки работы с фото -->
                                <Border Background="#FFF8E1" CornerRadius="12" Padding="15" Margin="0,0,0,15">
                                    <StackPanel>
                                        <TextBlock Text="📷 Управление фото" 
                                                   FontSize="14" 
                                                   FontWeight="SemiBold" 
                                                   Foreground="#333333" 
                                                   Margin="0,0,0,12"/>
                                        
                                        <Button Content="📤 Выбрать главное фото" 
                                                Command="{Binding SelectMainPhotoCommand}" 
                                                Style="{StaticResource PrimaryButton}" 
                                                Padding="15,10"
                                                FontSize="13"
                                                Margin="0,0,0,10"/>
                                        
                                        <Button Content="➕ Добавить фото в галерею" 
                                                Command="{Binding AddPhotoToGalleryCommand}" 
                                                Style="{StaticResource PrimaryButton}" 
                                                Padding="15,10"
                                                FontSize="13"
                                                Margin="0,0,0,10"/>
                                        
                                        <Button Content="🗑 Удалить выбранное фото" 
                                                Command="{Binding RemovePhotoUrlCommand}" 
                                                Padding="15,10"
                                                FontSize="13"
                                                Background="#FFE5E5"
                                                Foreground="#DC3545"
                                                BorderThickness="0"
                                                Cursor="Hand">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" 
                                                                        CornerRadius="10"
                                                                        Padding="{TemplateBinding Padding}">
                                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter Property="Background" Value="#DC3545"/>
                                                                        <Setter Property="Foreground" Value="White"/>
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>

                    <!-- Нижняя панель -->
                    <Border Grid.Row="2" Background="#F8F8F8" CornerRadius="0,0,25,25" Padding="30,20">
                        <Grid>
                            <Button Content="🗑 УДАЛИТЬ" 
                                    Command="{Binding DeleteCarCommand}" 
                                    Padding="25,12"
                                    FontSize="14"
                                    HorizontalAlignment="Left">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource DeclineButton}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding CarForEditing}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="ОТМЕНА" 
                                        Command="{Binding CloseCarDetailsCommand}" 
                                        Style="{StaticResource DeclineButton}" 
                                        Padding="25,12"
                                        FontSize="14"
                                        Margin="0,0,15,0"/>

                                <Button Content="💾 СОХРАНИТЬ" 
                                        Command="{Binding SaveCarCommand}" 
                                        Style="{StaticResource AcceptButton}" 
                                        Padding="30,12"
                                        FontSize="14"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
